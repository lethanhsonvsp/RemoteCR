@page "/"
@rendermode InteractiveServer

@inject RemoteCR.BmuService BmuService
@implements IDisposable

<h1>ĐANG TEST PIN KHÔNG ĐỘNG VÀO</h1>

<h3>🔋 BMU Monitor</h3>

@if (data == null || data.Count == 0)
{
    <p>⏳ Đang chờ dữ liệu...</p>
}
else
{
    <table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Thông số</th>
                <th>Ý nghĩa</th>
                <th>Giá trị</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in data)
            {
                <tr>
                    <td>@item.Key</td>
                    <td>@GetMeaning(item.Key, item.Value)</td>
                    <td>@item.Value</td>
                </tr>
            }
        </tbody>
    </table>
}

<h4 class="mt-4">📊 Thống kê</h4>
<table class="table table-bordered table-sm">
    <tbody>
        <tr>
            <td>Thời gian bắt đầu</td>
            <td>@BmuService.StartTime</td>
        </tr>
        <tr>
            <td>Thời gian chạy (uptime)</td>
            <td>@BmuService.Uptime.ToString(@"hh\:mm\:ss")</td>
        </tr>
        <tr>
            <td>Số lần OK</td>
            <td>@BmuService.SuccessCount</td>
        </tr>
        <tr>
            <td>Số lần lỗi</td>
            <td>@BmuService.ErrorCount</td>
        </tr>
        <tr>
            <td>Số lần sạc</td>
            <td>@BmuService.ChargeCount</td>
        </tr>
        <tr>
            <td>Số lần xả</td>
            <td>@BmuService.DischargeCount</td>
        </tr>
        <tr>
            <td>Pin bật?</td>
            <td>@(BmuService.BatteryEnabled ? "Bật" : "Tắt")</td>
        </tr>
        <tr>
            <td>Đang sạc?</td>
            <td>@(BmuService.IsCharging ? "Có" : "Không")</td>
        </tr>
        <tr>
            <td>Lỗi COM gần nhất</td>
            <td>@BmuService.LastComError</td>
        </tr>
        <tr>
            <td>Frame mismatch</td>
            <td>@BmuService.FrameMismatchCount</td>
        </tr>
    </tbody>
</table>

<h4 class="mt-4">❌ Thống kê lỗi</h4>
@if (BmuService.ErrorStats.Count == 0)
{
    <p>Không có lỗi.</p>
}
else
{
    <table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Loại lỗi</th>
                <th>Số lần</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var kv in BmuService.ErrorStats)
            {
                <tr>
                    <td>@kv.Key</td>
                    <td>@kv.Value</td>
                </tr>
            }
        </tbody>
    </table>
}

<button class="btn btn-sm btn-primary" @onclick="TryReconnect">Kết nối lại</button>

@code {
    private Dictionary<string, double> data = new();
    private System.Threading.Timer timer;

    private readonly Dictionary<string, string> Meanings = new()
    {
        { "Voltage", "Điện áp (V)" },
        { "Current", "Dòng điện (A)" },
        { "SOC", "Dung lượng còn lại (%)" },
        { "Status", "Trạng thái pin (bit flag)" },
        { "ChargeTime", "Thời gian còn lại để sạc đầy (phút)" },
        { "DischargeTime", "Thời gian còn lại để xả hết (phút)" },
        { "Temp", "Nhiệt độ (°C)" },
        { "SOH", "Tình trạng pin (%)" },
        { "RemainCapacity", "Dung lượng còn lại (Ah)" },
        { "RemainEnergy", "Năng lượng còn lại (Wh)" }
    };

    protected override void OnInitialized()
    {
        // Timer UI làm mới mỗi 500ms
        timer = new System.Threading.Timer(_ =>
        {
            data = BmuService.LastData ?? new Dictionary<string, double>();
            InvokeAsync(StateHasChanged);
        }, null, 0, 500);
    }

    private string GetMeaning(string key, double value)
    {
        if (key == "Status")
        {
            int status = (int)value;
            var alarms = new List<string>();
            if ((status & (1 << 0)) != 0) alarms.Add("Over Voltage");
            if ((status & (1 << 1)) != 0) alarms.Add("Low Voltage");
            if ((status & (1 << 2)) != 0) alarms.Add("Charge Over Current");
            if ((status & (1 << 3)) != 0) alarms.Add("Discharge Over Current");
            if ((status & (1 << 4)) != 0) alarms.Add("High Temp");
            if ((status & (1 << 5)) != 0) alarms.Add("Low Temp");
            if ((status & (1 << 6)) != 0) alarms.Add("BMU Error");

            return alarms.Count > 0
                ? string.Join(", ", alarms)
                : "Bình thường";
        }

        return Meanings.ContainsKey(key) ? Meanings[key] : "-";
    }

    private async Task TryReconnect()
    {
        await BmuService.TryReconnectAsync();
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}


