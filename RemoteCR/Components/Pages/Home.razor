@page "/"
@inject RemoteCR.BmuService BmuService

<h3>BMU Monitor</h3>

@if (data == null || data.Count == 0)
{
    <p>⏳ Đang chờ dữ liệu...</p>
}
else
{
    <table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Thông số</th>
                <th>Ý nghĩa</th>
                <th>Giá trị</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in data)
            {
                <tr>
                    <td>@item.Key</td>
                    <td>@GetMeaning(item.Key, item.Value)</td>
                    <td>@item.Value</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private Dictionary<string, double> data;
    private System.Threading.Timer timer;

    private readonly Dictionary<string, string> Meanings = new()
    {
        { "Voltage", "Điện áp (V)" },
        { "Current", "Dòng điện (A)" },
        { "SOC", "Dung lượng còn lại (%)" },
        { "Status", "Trạng thái pin (bit flag)" },
        { "ChargeTime", "Thời gian còn lại để sạc đầy (phút)" },
        { "DischargeTime", "Thời gian còn lại để xả hết (phút)" },
        { "Temp", "Nhiệt độ (°C)" },
        { "SOH", "Tình trạng pin (%)" },
        { "RemainCapacity", "Dung lượng còn lại (Ah)" },
        { "RemainEnergy", "Năng lượng còn lại (Wh)" }
    };

    protected override void OnInitialized()
    {
        timer = new System.Threading.Timer(_ =>
        {
            data = BmuService.LastData;
            InvokeAsync(StateHasChanged);
        }, null, 0, 500);
    }

    private string GetMeaning(string key, double value)
    {
        if (key == "Status")
        {
            int status = (int)value;
            var alarms = new List<string>();
            if ((status & (1 << 0)) != 0) alarms.Add("Over Voltage");
            if ((status & (1 << 1)) != 0) alarms.Add("Low Voltage");
            if ((status & (1 << 2)) != 0) alarms.Add("Charge Over Current");
            if ((status & (1 << 3)) != 0) alarms.Add("Discharge Over Current");
            if ((status & (1 << 4)) != 0) alarms.Add("High Temp");
            if ((status & (1 << 5)) != 0) alarms.Add("Low Temp");
            if ((status & (1 << 6)) != 0) alarms.Add("BMU Error");

            return alarms.Count > 0
                ? string.Join(", ", alarms)
                : "Bình thường";
        }

        return Meanings.ContainsKey(key) ? Meanings[key] : "-";
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
