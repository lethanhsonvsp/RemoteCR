@page "/"
@using RemoteCR.Services.Modbus
@rendermode InteractiveServer

@inject TadaService BmuService
@implements IDisposable
@inject RemoteCR.Services.Can.CanStateContainer State
@inject RemoteCR.Services.Can.DeltaChargerCommandService dccs

<style>
    .status-dot {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-left: 10px;
    }

        .status-dot.online {
            background-color: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        .status-dot.offline {
            background-color: #dc3545;
            box-shadow: 0 0 8px #dc3545;
        }

    /* ---- GRID LAYOUT 1x2 ---- */
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    /* Responsive: tự xuống 1 cột khi màn hình nhỏ */
    @@media (max-width: 992px) {
        .grid-container {
            grid-template-columns: 1fr;
        }
    }

    .card-block {
        padding: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 0 12px rgba(0,0,0,0.10);
    }
</style>

<h1 class="mb-4">🔋 Charger & Battery Dashboard</h1>

<div class="grid-container">

    <!-- ====================== -->
    <!-- 🔷 LEFT: DELTA CHARGER -->
    <!-- ====================== -->

    <div class="card-block">
        <h2 class="mb-3 d-flex align-items-center">
            Delta 1kW Wireless Charger
        </h2>
        <h3>
            <span class="status-dot @(State.IsConnected ? "online" : "offline")"></span>
            <small class="ms-2">
                @(State.IsConnected ? "Connected" : "Disconnected")
            </small>
        </h3>
        <h4>Electrical</h4>
        <p><b>Voltage:</b> @State.Voltage:F2 V</p>
        <p><b>Current:</b> @State.Current:F2 A</p>
        <p><b>Power:</b> @State.Power:F2 W</p>

        <h4 class="mt-3">Wireless Parameters</h4>
        <p><b>Gap:</b> @State.Gap mm</p>
        <p><b>Primary Temp:</b> @State.PriTemp °C</p>
        <p><b>Secondary Temp:</b> @State.SecTemp °C</p>
        <button class="btn btn-sm btn-primary" @onclick="SendOnceOn">Once On</button>
        <button class="btn btn-sm btn-primary" @onclick="SendOnceOff">Once Off</button>
        <button class="btn btn-sm btn-primary" @onclick="StartLoopOn">S On</button>
        <button class="btn btn-sm btn-primary" @onclick="StartLoopOff">S Off</button>
        @if (State.Status.Any())
        {
            <div class="alert alert-info mt-3">
                <h4>Status</h4>
                <ul>
                    @foreach (var s in State.Status)
                    {
                        <li>@s</li>
                    }
                </ul>
            </div>
        }

        @if (State.Faults.Any())
        {
            <div class="alert alert-danger mt-3">
                <h4>Faults</h4>
                <ul>
                    @foreach (var f in State.Faults)
                    {
                        <li>@f</li>
                    }
                </ul>
            </div>
        }

        <div class="card p-3 mt-3">
            <h4>Firmware Versions</h4>
            <p><b>MCU1:</b> @State.RevMCU1</p>
            <p><b>MCU2:</b> @State.RevMCU2</p>
            <p><b>DSP:</b> @State.RevDSP</p>
        </div>
    </div>


    <!-- =========================== -->
    <!-- 🔶 RIGHT: BATTERY (TADA BMU) -->
    <!-- =========================== -->

    <div class="card-block">

        <h2 class="mb-3">🔌 Tada Battery Monitor</h2>

        @if (data == null || data.Count == 0)
        {
            <p>⏳ Đang chờ dữ liệu...</p>
        }
        else
        {
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Thông số</th>
                        <th>Ý nghĩa</th>
                        <th>Giá trị</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in data)
                    {
                        <tr>
                            <td>@item.Key</td>
                            <td>@GetMeaning(item.Key, item.Value)</td>
                            <td>@item.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <h4 class="mt-4">📊 Thống kê</h4>
        <table class="table table-bordered table-sm">
            <tbody>
                <tr><td>Thời gian bắt đầu</td><td>@BmuService.StartTime</td></tr>
                <tr><td>Uptime</td><td>@BmuService.Uptime.ToString(@"hh\:mm\:ss")</td></tr>
                <tr><td>Số lần OK</td><td>@BmuService.SuccessCount</td></tr>
                <tr><td>Số lần lỗi</td><td>@BmuService.ErrorCount</td></tr>
                <tr><td>Số lần sạc</td><td>@BmuService.ChargeCount</td></tr>
                <tr><td>Số lần xả</td><td>@BmuService.DischargeCount</td></tr>
                <tr><td>Pin bật?</td><td>@(BmuService.BatteryEnabled ? "Bật" : "Tắt")</td></tr>
                <tr><td>Đang sạc?</td><td>@(BmuService.IsCharging ? "Có" : "Không")</td></tr>
                <tr><td>Lỗi COM gần nhất</td><td>@BmuService.LastComError</td></tr>
                <tr><td>Frame mismatch</td><td>@BmuService.FrameMismatchCount</td></tr>
            </tbody>
        </table>

        <h4 class="mt-4">❌ Thống kê lỗi</h4>
        @if (BmuService.ErrorStats.Count == 0)
        {
            <p>Không có lỗi.</p>
        }
        else
        {
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Loại lỗi</th>
                        <th>Số lần</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kv in BmuService.ErrorStats)
                    {
                        <tr>
                            <td>@kv.Key</td>
                            <td>@kv.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <button class="btn btn-sm btn-primary" @onclick="TryReconnect">Kết nối lại</button>

    </div>

</div>

@code {
    private Dictionary<string, double> data = new();
    private System.Threading.Timer? timer;

    protected override void OnInitialized()
    {
        State.OnChange += () => InvokeAsync(StateHasChanged);

        timer = new System.Threading.Timer(_ =>
        {
            data = BmuService.LastData ?? new Dictionary<string, double>();
            InvokeAsync(StateHasChanged);
        }, null, 0, 500);
    }

    private string GetMeaning(string key, double value)
    {
        var map = new Dictionary<string, string>
        {
            { "Voltage", "Điện áp (V)" },
            { "Current", "Dòng điện (A)" },
            { "SOC", "Dung lượng còn lại (%)" },
            { "Status", "Trạng thái pin (bit flag)" },
            { "ChargeTime", "Thời gian sạc đầy (phút)" },
            { "DischargeTime", "Thời gian xả hết (phút)" },
            { "Temp", "Nhiệt độ (°C)" },
            { "SOH", "Tình trạng pin (%)" },
            { "RemainCapacity", "Dung lượng còn lại (Ah)" },
            { "RemainEnergy", "Năng lượng còn lại (Wh)" }
        };

        return map.TryGetValue(key, out var meaning) ? meaning : "-";
    }
    double voltage;
    double current;
    private void SendOnceOn() => dccs.SendOnce( voltage,  current, true);
    private void SendOnceOff() => dccs.SendOnce( voltage,  current, false);
    private void StartLoopOn() => dccs.SendOnce(voltage, current, true);
    private void StartLoopOff() => dccs.SendOnce(voltage, current, false);

    private async Task TryReconnect() => await BmuService.TryReconnectAsync();

    public void Dispose() => timer?.Dispose();
}
