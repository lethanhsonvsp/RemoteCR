@page "/counter"
@using RemoteCR.Services.Modbus
@rendermode InteractiveServer
@inject ModbusBackgroundService ModbusService 

<h3 class="mb-4 fw-bold text-dark">📡 Trạng thái thiết bị RS-485</h3>

@if (state is null)
{
    <div class="alert alert-info d-flex align-items-center gap-2">
        <i class="bi bi-hourglass-split"></i> Đang chờ dữ liệu...
    </div>
}
else
{
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-4">

            <!-- Trạng thái cơ bản -->
            <div class="row mb-4">
                <div class="col-6 d-flex align-items-center gap-2">
                    <b>Heartbeat:</b>
                    <span class="badge @(state.Heartbeat ? "bg-success" : "bg-secondary") rounded-pill">
                        @(state.Heartbeat ? "ON" : "OFF")
                    </span>
                </div>
                <div class="col-6 d-flex align-items-center gap-2">
                    <b>Locked:</b>
                    <span class="badge @(state.Locked ? "bg-danger" : "bg-success") rounded-pill">
                        @(state.Locked ? "YES" : "NO")
                    </span>
                </div>
            </div>

            <div class="mb-3">
                @if (state.LostLink)
                {
                    <div class="alert alert-danger d-flex align-items-center gap-2 p-3 rounded-3">
                        <i class="bi bi-exclamation-triangle-fill"></i> MẤT KẾT NỐI TAY CẦM
                    </div>
                }
                else
                {
                    <b>LostLink:</b>
                    <span class="badge bg-success rounded-pill">NO</span>
                }
            </div>

            <div class="mb-4">
                <b>EStop:</b>
                <span class="badge @(state.EStop ? "bg-danger" : "bg-success") rounded-pill">
                    @(state.EStop ? "YES" : "NO")
                </span>
            </div>

            <!-- Chế độ -->
            <div class="mb-4">
                <b>Chế độ:</b>
                <span class="badge bg-info text-dark rounded-pill">
                    @state.Mode
                </span>
            </div>


            <!-- Action -->
            <div class="mb-4">
                <b>Action:</b>
                <div class="mt-2">
                    @RenderActiveAction("Lift Up", state.LiftUp)
                    @RenderActiveAction("Lift Down", state.LiftDown)
                    @RenderActiveAction("Rotate Left", state.RotateLeft)
                    @RenderActiveAction("Rotate Right", state.RotateRight)
                    @RenderActiveAction("Forward", state.Forward)
                    @RenderActiveAction("Backward", state.Backward)
                    @RenderActiveAction("Left", state.Left)
                    @RenderActiveAction("Right", state.Right)
                    @RenderActiveAction("Mode Select", state.ModeSelect)
                    @RenderActiveAction("Enable", state.Enable)

                    @if (!AnyActionPressed())
                    {
                        <span class="text-muted">Không có nút nào được bấm</span>
                    }
                </div>
            </div>

            <!-- Speed -->
            @if (state.Speed > 0)
            {
                <label class="form-label fw-semibold"><b>Tốc độ</b> (@state.Speed%)</label>
                <div class="progress rounded-3" style="height: 24px;">
                    <div class="progress-bar bg-info progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         style="width:@state.Speed%; transition: width 0.3s ease-in-out;"
                         aria-valuenow="@state.Speed"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        @state.Speed%
                    </div>
                </div>
            }
        </div>
    </div>
}

<style>
    .badge-action {
        margin: 0.2rem;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
    }
</style>

@code {
    private DeviceState? state;

    protected override void OnInitialized()
    {
        ModbusService.OnStateChanged += s =>
        {
            state = s;
            InvokeAsync(StateHasChanged);
        };
    }

    private string GetMode()
    {
        if (state == null) return "Unknown";

        // Ví dụ: mode xác định theo Enable/ModeSelect (bạn có thể thay đổi logic cho phù hợp)
        if (state.Enable) return "Enable";
        if (state.ModeSelect) return "Mode Select";
        return "Default";
    }

    private RenderFragment RenderActiveAction(string label, bool isActive) => builder =>
    {
        if (isActive)
        {
            builder.OpenElement(0, "span");
            builder.AddAttribute(1, "class", "badge bg-primary badge-action");
            builder.AddContent(2, label);
            builder.CloseElement();
        }
    };
    private bool AnyActionPressed()
    {
        if (state == null) return false;
        return state.LiftUp || state.LiftDown || state.RotateLeft || state.RotateRight ||
               state.Forward || state.Backward || state.Left || state.Right ||
               state.ModeSelect || state.Enable;
    }
}
