@page "/"
@rendermode InteractiveServer

@using RemoteCR.Services.Can
@inject CanSocketReaderService Reader
@inject CanSocketWriterService Writer
@inject SocketCan Can
@implements IDisposable

<h3>⚡ Wireless Charger Dashboard</h3>

<h5>
    <span style="
        display:inline-block;
        width:14px;height:14px;
        border-radius:50%;
        background:@(IsConnected ? "green" : "red");
        margin-right:6px">
    </span>
    @(IsConnected ? "Connected" : "Disconnected")
</h5>

<div style="max-width:420px">

    <p><b>Voltage:</b> @Fmt(Reader.Model?.Voltage_V) V</p>
    <p><b>Current:</b> @Fmt(Reader.Model?.Current_A) A</p>
    <p><b>Gap:</b> @Fmt(Reader.Model?.Wireless?.Gap_mm) mm</p>

    <hr />

    <div>
        <label>Demand Voltage</label><br />
        <input type="number" step="0.5"
               value="@Cmd.DemandVoltage_V"
               @onchange="OnVoltageChanged"
               disabled="@(!IsConnected)" />
    </div>

    <div>
        <label>Demand Current</label><br />
        <input type="number" step="0.5"
               value="@Cmd.DemandCurrent_A"
               @onchange="OnCurrentChanged"
               disabled="@(!IsConnected)" />
    </div>

    <br />

    <button @onclick="PowerOn" disabled="@(!CanEnable)">▶ POWER ON</button>
    <button @onclick="PowerOff" disabled="@(!IsConnected)">■ POWER OFF</button>
    <button @onclick="ClearFault" disabled="@(!IsConnected)">⚠ CLEAR FAULT</button>

    <hr />

    <p>
        <input type="checkbox" checked="@Reader.Model?.Charging" disabled />
        Charging
    </p>

    <p>
        <input type="checkbox" checked="@Reader.Model?.Fault" disabled />
        Fault
    </p>

</div>

@code {
    ControlModuleCommand Cmd = new();

    bool IsConnected => Can.IsConnected;

    bool CanEnable =>
        IsConnected &&
        Reader.Model?.WirelessStatusReport?.WirelessOk == true &&
        (Reader.Model?.Wireless?.Gap_mm ?? 999) < 20 &&
        Reader.Model?.Fault != true;

    protected override void OnInitialized()
    {
        Cmd.DemandVoltage_V = 48;
        Cmd.DemandCurrent_A = 10;

        Writer.SetCommand(Cmd);
        Reader.OnChange += Refresh;
    }

    void Refresh() => InvokeAsync(StateHasChanged);

    public void Dispose() => Reader.OnChange -= Refresh;

    void OnVoltageChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var v))
        {
            Cmd.DemandVoltage_V = v;
            Writer.SetCommand(Cmd);
        }
    }

    void OnCurrentChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var a))
        {
            Cmd.DemandCurrent_A = a;
            Writer.SetCommand(Cmd);
        }
    }

    async Task PowerOn()
    {
        // 🔴 BẮT BUỘC
        Cmd.PowerStage1 = true;
        Cmd.PowerStages[0] = true;

        // Clear fault pulse
        Cmd.ClearFaults = true;
        Writer.SetCommand(Cmd);

        await Task.Delay(200);

        Cmd.ClearFaults = false;
        Writer.SetCommand(Cmd);
    }

    void PowerOff()
    {
        Cmd.PowerStage1 = false;

        for (int i = 0; i < Cmd.PowerStages.Length; i++)
            Cmd.PowerStages[i] = false;

        Writer.SetCommand(Cmd);
    }

    async Task ClearFault()
    {
        Cmd.ClearFaults = true;
        Writer.SetCommand(Cmd);

        await Task.Delay(200);

        Cmd.ClearFaults = false;
        Writer.SetCommand(Cmd);
    }

    string Fmt(double? v) => v.HasValue ? v.Value.ToString("F1") : "--";
}
